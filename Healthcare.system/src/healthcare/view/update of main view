package healthcare.view;

import healthcare.controller.*;
import healthcare.model.Appointment;
import healthcare.model.Prescription;
import healthcare.model.Referral;
import healthcare.util.CSVUtil;
import healthcare.model.Patient;
import javax.swing.*;
import javax.swing.border.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.time.LocalDate;
import java.time.LocalTime;

public class MainView extends JFrame {
    private JTabbedPane tabbedPane;
    private JTable appointmentTable, prescriptionTable, referralTable, patientTable;
    private DefaultTableModel aptModel, prescModel, refModel, patModel;

    private AppointmentController appointmentController;
    private PrescriptionController prescriptionController;
    private ReferralController referralController;
    private PatientController patientController;

    public MainView(AppointmentController ac, PrescriptionController pc, ReferralController rc, PatientController patc) {
        this.appointmentController = ac;
        this.prescriptionController = pc;
        this.referralController = rc;
        this.patientController = patc;

        setTitle("Healthcare Management System");
        setSize(1300, 800);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        getContentPane().setBackground(new Color(240, 248, 255));

        JLabel titleLabel = new JLabel("Healthcare Management System", JLabel.CENTER);
        titleLabel.setFont(new Font("Segoe UI", Font.BOLD, 32));
        titleLabel.setForeground(new Color(0, 102, 204));
        titleLabel.setBorder(new EmptyBorder(20, 0, 20, 0));
        add(titleLabel, BorderLayout.NORTH);

        tabbedPane = new JTabbedPane();
        tabbedPane.setFont(new Font("Segoe UI", Font.BOLD, 16));
        tabbedPane.setBackground(Color.WHITE);
        tabbedPane.setForeground(new Color(0, 102, 204));

        tabbedPane.addTab(" Appointments", createStyledPanel(createAppointmentPanel()));
        tabbedPane.addTab(" Prescriptions", createStyledPanel(createPrescriptionPanel()));
        tabbedPane.addTab(" Referrals", createStyledPanel(createReferralPanel()));
        tabbedPane.addTab(" Patients", createStyledPanel(createPatientPanel()));

        add(tabbedPane, BorderLayout.CENTER);
        setVisible(true);
    }

    private JPanel createStyledPanel(JPanel innerPanel) {
        JPanel wrapper = new JPanel(new BorderLayout());
        wrapper.setBorder(new EmptyBorder(20, 20, 20, 20));
        wrapper.setBackground(Color.WHITE);
        wrapper.add(innerPanel, BorderLayout.CENTER);
        return wrapper;
    }

    private JPanel createAppointmentPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(Color.WHITE);
        aptModel = new DefaultTableModel(new String[]{
                "Appointment ID", "Date", "Time", "Patient ID", "Clinician ID"
            }, 0);
        appointmentTable = new JTable(aptModel);
        formatTable(appointmentTable);
        panel.add(new JScrollPane(appointmentTable), BorderLayout.CENTER);

        JPanel btnPanel = createButtonPanel();
        JButton refreshBtn = createStyledButton("Refresh", new Color(52, 152, 219));
        JButton addBtn = createStyledButton("Add Appointment", new Color(52, 152, 219));
        JButton editBtn = createStyledButton("Edit Selected", new Color(52, 152, 219));
        JButton deleteBtn = createStyledButton("Delete Selected", new Color(52, 152, 219));

        refreshBtn.addActionListener(e -> loadAppointments());
        addBtn.addActionListener(e -> showAddAppointmentDialog());
        editBtn.addActionListener(e -> editAppointment());
        deleteBtn.addActionListener(e -> deleteAppointment());

        btnPanel.add(refreshBtn); btnPanel.add(addBtn); btnPanel.add(editBtn); btnPanel.add(deleteBtn);
        panel.add(btnPanel, BorderLayout.SOUTH);

        loadAppointments();
        return panel;
    }

    private JPanel createPrescriptionPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(Color.WHITE);
        prescModel = new DefaultTableModel(new String[]{
                "Prescription ID", "Patient ID", "Clinician ID", "Appointment ID",
                "Medication", "Dosage", "Frequency", "Duration", "Quantity",
                "Instructions", "Status", "Issue Date", "Collection Date"
            }, 0);
        prescriptionTable = new JTable(prescModel);
        formatTable(prescriptionTable);
        panel.add(new JScrollPane(prescriptionTable), BorderLayout.CENTER);

        JPanel btnPanel = createButtonPanel();
        JButton refreshBtn = createStyledButton("Refresh", new Color(52, 152, 219));
        JButton addBtn = createStyledButton("Issue Prescription", new Color(52, 152, 219));
        JButton editBtn = createStyledButton("Edit Selected", new Color(52, 152, 219));
        JButton deleteBtn = createStyledButton("Delete Selected", new Color(52, 152, 219));

        refreshBtn.addActionListener(e -> loadPrescriptions());
        addBtn.addActionListener(e -> showAddPrescriptionDialog());
        editBtn.addActionListener(e -> editPrescription());
        deleteBtn.addActionListener(e -> deletePrescription());

        btnPanel.add(refreshBtn); btnPanel.add(addBtn); btnPanel.add(editBtn); btnPanel.add(deleteBtn);
        panel.add(btnPanel, BorderLayout.SOUTH);

        loadPrescriptions();
        return panel;
    }

    private JPanel createReferralPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(Color.WHITE);
        refModel = new DefaultTableModel(new String[]{
                "Referral ID", "Patient ID", "Referring Clin ID", "Referred To Clin ID",
                "Referring Facility", "Referred To Facility", "Date", "Urgency",
                "Reason", "Status", "Notes"
            }, 0);
        referralTable = new JTable(refModel);
        formatTable(referralTable);
        panel.add(new JScrollPane(referralTable), BorderLayout.CENTER);

        JPanel btnPanel = createButtonPanel();
        JButton refreshBtn = createStyledButton("Refresh", new Color(52, 152, 219));
        JButton addBtn = createStyledButton("Make Referral", new Color(52, 152, 219));
        JButton editBtn = createStyledButton("Edit Selected", new Color(52, 152, 219));
        JButton deleteBtn = createStyledButton("Delete Selected", new Color(52, 152, 219));

        refreshBtn.addActionListener(e -> loadReferrals());
        addBtn.addActionListener(e -> showAddReferralDialog());
        editBtn.addActionListener(e -> editReferral());
        deleteBtn.addActionListener(e -> deleteReferral());

        btnPanel.add(refreshBtn); btnPanel.add(addBtn); btnPanel.add(editBtn); btnPanel.add(deleteBtn);
        panel.add(btnPanel, BorderLayout.SOUTH);

        loadReferrals();
        return panel;
    }

    private JPanel createPatientPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(Color.WHITE);
        patModel = new DefaultTableModel(new String[]{
                "Patient ID", "First Name", "Last Name", "Date of Birth",
                "NHS Number", "Gender", "Phone", "Email",
                "Address", "Postcode", "Emergency Contact", "Emergency Phone",
                "Registration Date", "GP Surgery ID"
            }, 0);
        patientTable = new JTable(patModel);
        formatTable(patientTable);
        panel.add(new JScrollPane(patientTable), BorderLayout.CENTER);

        JPanel btnPanel = createButtonPanel();
        JButton refreshBtn = createStyledButton("Refresh", new Color(52, 152, 219));
        JButton addBtn = createStyledButton("Register Patient", new Color(52, 152, 219));
        JButton editBtn = createStyledButton("Edit History", new Color(52, 152, 219));
        JButton deleteBtn = createStyledButton("Delete Selected", new Color(52, 152, 219));

        refreshBtn.addActionListener(e -> loadPatients());
        addBtn.addActionListener(e -> showAddPatientDialog());
        editBtn.addActionListener(e -> editPatientHistory());
        deleteBtn.addActionListener(e -> deletePatient());

        btnPanel.add(refreshBtn); btnPanel.add(addBtn); btnPanel.add(editBtn); btnPanel.add(deleteBtn);
        panel.add(btnPanel, BorderLayout.SOUTH);

        loadPatients();
        return panel;
    }

    private void formatTable(JTable table) {
        table.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        table.setRowHeight(35);
        table.getTableHeader().setFont(new Font("Segoe UI", Font.BOLD, 15));
        table.getTableHeader().setBackground(new Color(0, 102, 204));
        table.getTableHeader().setForeground(Color.WHITE);
        table.setGridColor(new Color(200, 200, 200));
        table.setSelectionBackground(new Color(173, 216, 230));
    }

    private JPanel createButtonPanel() {
        JPanel panel = new JPanel();
        panel.setBackground(Color.WHITE);
        panel.setBorder(new EmptyBorder(20, 0, 20, 0));
        return panel;
    }

    private JButton createStyledButton(String text, Color bgColor) {
        JButton btn = new JButton(text);
        btn.setFont(new Font("Segoe UI", Font.BOLD, 14));
        btn.setBackground(bgColor);
        btn.setForeground(Color.WHITE);
        btn.setFocusPainted(false);
        btn.setBorder(new EmptyBorder(12, 24, 12, 24));
        btn.setCursor(new Cursor(Cursor.HAND_CURSOR));
        btn.setPreferredSize(new Dimension(180, 45));
        return btn;
    }

    // REAL DATA LOADING
    private void loadAppointments() {
        aptModel.setRowCount(0);
        java.util.List data = CSVUtil.readCSV("appointments.csv");
        if (data.isEmpty()) return;

        // Skip header
        for (int i = 1; i < data.size(); i++) {
            String[] row = (String[]) data.get(i);
            if (row.length >= 11) {
                aptModel.addRow(new Object[]{
                    row[0],  // appointment_id
                    row[4],  // appointment_date
                    row[5],  // appointment_time
                    row[1],  // patient_id
                    row[2]   // clinician_id
                });
            }
        }
    }

    private void loadPrescriptions() {
        prescModel.setRowCount(0);
        java.util.List data = CSVUtil.readCSV("prescriptions.csv");
        if (data.isEmpty()) return;

        for (int i = 1; i < data.size(); i++) {
            String[] row = (String[]) data.get(i);
            if (row.length >= 13) {
                prescModel.addRow(new Object[]{
                    row[0], row[1], row[2], row[3],
                    row[4], row[5], row[6], row[7], row[8],
                    row[9], row[10], row[11], row[12]
                });
            }
        }
    }

    private void loadReferrals() {
        refModel.setRowCount(0);
        java.util.List data = CSVUtil.readCSV("referrals.csv");
        if (data.isEmpty()) return;

        for (int i = 1; i < data.size(); i++) {
            String[] row = (String[]) data.get(i);
            if (row.length >= 15) {
                refModel.addRow(new Object[]{
                    row[0], row[1], row[2], row[3],
                    row[4], row[5], row[6], row[7],
                    row[8], row[11], row[12]
                });
            }
        }
    }
    private void loadPatients() {
        patModel.setRowCount(0);
        
        // Use the exact filename you provided
        java.util.List<String[]> data = CSVUtil.readCSV("patients.csv");
        
        if (data.isEmpty() || data.size() == 1) {
            System.out.println("No patient data found in patients.csv");
            return;
        }

        // Skip header row
        for (int i = 1; i < data.size(); i++) {
            String[] row = data.get(i);
            
            // Ensure we have at least 14 columns
            if (row.length >= 14) {
                patModel.addRow(new Object[]{
                    row[0],  // Patient ID
                    row[1],  // First Name
                    row[2],  // Last Name
                    row[3],  // Date of Birth
                    row[4],  // NHS Number
                    row[5],  // Gender
                    row[6],  // Phone Number
                    row[7],  // Email
                    row[8],  // Address (now correctly handles commas inside quotes)
                    row[9],  // Postcode
                    row[10], // Emergency Contact Name
                    row[11], // Emergency Contact Phone
                    row[12], // Registration Date
                    row[13]  // GP Surgery ID
                });
            } else {
                System.out.println("Skipping malformed row: " + java.util.Arrays.toString(row));
            }
        }
    }
 
    // ADD DIALOGS (SAFE)
    private void showAddAppointmentDialog() {
        JTextField patId = new JTextField(5);
        JTextField docId = new JTextField(5);
        JPanel p = new JPanel(new GridLayout(0, 2));
        p.add(new JLabel("Patient ID:")); p.add(patId);
        p.add(new JLabel("Doctor ID:")); p.add(docId);

        if (JOptionPane.showConfirmDialog(this, p, "Add Appointment", JOptionPane.OK_CANCEL_OPTION) == JOptionPane.OK_OPTION) {
            try {
                int pId = Integer.parseInt(patId.getText().trim());
                int dId = Integer.parseInt(docId.getText().trim());
                appointmentController.bookAppointment(pId, dId, LocalDate.now(), LocalTime.now());
                loadAppointments();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Invalid input! IDs must be numbers.");
            }
        }
    }

    private void showAddPrescriptionDialog() {
        JTextField patId = new JTextField(5);
        JTextField condition = new JTextField(15);
        JTextField drug = new JTextField(15);
        JPanel p = new JPanel(new GridLayout(0, 2));
        p.add(new JLabel("Patient ID:")); p.add(patId);
        p.add(new JLabel("Condition:")); p.add(condition);
        p.add(new JLabel("Drug:")); p.add(drug);

        if (JOptionPane.showConfirmDialog(this, p, "Issue Prescription", JOptionPane.OK_CANCEL_OPTION) == JOptionPane.OK_OPTION) {
            try {
                int pId = Integer.parseInt(patId.getText().trim());
                prescriptionController.createPrescription(pId, condition.getText(), drug.getText(), LocalDate.now());
                loadPrescriptions();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Patient ID must be a number!");
            }
        }
    }

    private void showAddReferralDialog() {
        JTextField patId = new JTextField(5);
        JTextField gpId = new JTextField(5);
        JTextField specId = new JTextField(5);
        JTextField reason = new JTextField(20);
        JPanel p = new JPanel(new GridLayout(0, 2));
        p.add(new JLabel("Patient ID:")); p.add(patId);
        p.add(new JLabel("GP ID:")); p.add(gpId);
        p.add(new JLabel("Specialist ID:")); p.add(specId);
        p.add(new JLabel("Reason:")); p.add(reason);

        if (JOptionPane.showConfirmDialog(this, p, "Make Referral", JOptionPane.OK_CANCEL_OPTION) == JOptionPane.OK_OPTION) {
            try {
                int pId = Integer.parseInt(patId.getText().trim());
                int gId = Integer.parseInt(gpId.getText().trim());
                int sId = Integer.parseInt(specId.getText().trim());
                referralController.makeReferral(pId, gId, sId, reason.getText(), LocalDate.now(), "Referral note");
                patientController.updateEHR(pId, "Referred: " + reason.getText());
                loadReferrals();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "IDs must be numbers!");
            }
        }
    }

    private void showAddPatientDialog() {
        JTextField dob = new JTextField("yyyy-mm-dd", 10);
        JPanel p = new JPanel();
        p.add(new JLabel("DOB (yyyy-mm-dd):")); p.add(dob);

        if (JOptionPane.showConfirmDialog(this, p, "Register Patient", JOptionPane.OK_CANCEL_OPTION) == JOptionPane.OK_OPTION) {
            try {
                LocalDate date = LocalDate.parse(dob.getText().trim());
                patientController.registerPatient(date, "New patient registered");
                loadPatients();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Invalid date format! Use yyyy-mm-dd");
            }
        }
    }

    // EDIT AND DELETE (demo â€” updates table)
    private void editAppointment() {
        int row = appointmentTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select an appointment!"); return; }
        String newTime = JOptionPane.showInputDialog("New Time (HH:mm):", aptModel.getValueAt(row, 2));
        if (newTime != null) {
            aptModel.setValueAt(newTime, row, 2);
            JOptionPane.showMessageDialog(this, "Appointment updated!");
        }
    }

    private void editPrescription() {
        int row = prescriptionTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a prescription!"); return; }
        String newDrug = JOptionPane.showInputDialog("New Drug:", prescModel.getValueAt(row, 3));
        if (newDrug != null) {
            prescModel.setValueAt(newDrug, row, 3);
            JOptionPane.showMessageDialog(this, "Prescription updated!");
        }
    }

    private void editReferral() {
        int row = referralTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a referral!"); return; }
        String newReason = JOptionPane.showInputDialog("New Reason:", refModel.getValueAt(row, 4));
        if (newReason != null) {
            refModel.setValueAt(newReason, row, 4);
            JOptionPane.showMessageDialog(this, "Referral updated!");
        }
    }

    private void editPatientHistory() {
        int row = patientTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a patient!"); return; }
        int id = (int) patModel.getValueAt(row, 0);
        String newHistory = JOptionPane.showInputDialog("New Medical History:", patModel.getValueAt(row, 2));
        if (newHistory != null) {
            patientController.updateEHR(id, newHistory);
            loadPatients();
        }
    }

    private void deleteAppointment() {
        int row = appointmentTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select an appointment!"); return; }
        if (JOptionPane.showConfirmDialog(this, "Delete this appointment?") == JOptionPane.YES_OPTION) {
            aptModel.removeRow(row);
            JOptionPane.showMessageDialog(this, "Appointment deleted!");
        }
    }

    private void deletePrescription() {
        int row = prescriptionTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a prescription!"); return; }
        if (JOptionPane.showConfirmDialog(this, "Delete this prescription?") == JOptionPane.YES_OPTION) {
            prescModel.removeRow(row);
            JOptionPane.showMessageDialog(this, "Prescription deleted!");
        }
    }

    private void deleteReferral() {
        int row = referralTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a referral!"); return; }
        if (JOptionPane.showConfirmDialog(this, "Delete this referral?") == JOptionPane.YES_OPTION) {
            refModel.removeRow(row);
            JOptionPane.showMessageDialog(this, "Referral deleted!");
        }
    }

    private void deletePatient() {
        int row = patientTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a patient!"); return; }
        if (JOptionPane.showConfirmDialog(this, "Delete this patient?") == JOptionPane.YES_OPTION) {
            patModel.removeRow(row);
            JOptionPane.showMessageDialog(this, "Patient deleted!");
        }
    }
}
