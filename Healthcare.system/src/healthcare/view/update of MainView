package healthcare.view;

import healthcare.controller.*;
import healthcare.model.*;
import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.time.LocalDate;
import java.time.LocalTime;

public class MainView extends JFrame {
    private JTabbedPane tabbedPane;
    private JTable appointmentTable, prescriptionTable, referralTable, patientTable;
    private DefaultTableModel aptModel, prescModel, refModel, patModel;

    private AppointmentController appointmentController;
    private PrescriptionController prescriptionController;
    private ReferralController referralController;
    private PatientController patientController;

    public MainView(AppointmentController ac, PrescriptionController pc, ReferralController rc, PatientController patc) {
        this.appointmentController = ac;
        this.prescriptionController = pc;
        this.referralController = rc;
        this.patientController = patc;

        setTitle("Healthcare Management System - MVC Architecture");
        setSize(1200, 750);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        tabbedPane = new JTabbedPane();
        tabbedPane.addTab("Appointments", createAppointmentPanel());
        tabbedPane.addTab("Prescriptions", createPrescriptionPanel());
        tabbedPane.addTab("Referrals", createReferralPanel());
        tabbedPane.addTab("Patients", createPatientPanel());

        add(tabbedPane);
        setVisible(true);
    }

    private JPanel createAppointmentPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        aptModel = new DefaultTableModel(new String[]{"ID", "Date", "Time", "Patient ID", "Doctor ID"}, 0);
        appointmentTable = new JTable(aptModel);
        panel.add(new JScrollPane(appointmentTable), BorderLayout.CENTER);

        JPanel btnPanel = new JPanel();
        JButton refreshBtn = new JButton("Refresh");
        JButton addBtn = new JButton("Add Appointment");
        JButton editBtn = new JButton("Edit Selected");
        JButton deleteBtn = new JButton("Delete Selected");

        refreshBtn.addActionListener(e -> loadAppointments());
        addBtn.addActionListener(e -> showAddAppointmentDialog());
        editBtn.addActionListener(e -> editAppointment());
        deleteBtn.addActionListener(e -> deleteAppointment());

        btnPanel.add(refreshBtn); btnPanel.add(addBtn); btnPanel.add(editBtn); btnPanel.add(deleteBtn);
        panel.add(btnPanel, BorderLayout.SOUTH);

        loadAppointments();
        return panel;
    }

    private JPanel createPrescriptionPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        prescModel = new DefaultTableModel(new String[]{"ID", "Patient ID", "Condition", "Drug", "Date"}, 0);
        prescriptionTable = new JTable(prescModel);
        panel.add(new JScrollPane(prescriptionTable), BorderLayout.CENTER);

        JPanel btnPanel = new JPanel();
        JButton refreshBtn = new JButton("Refresh");
        JButton addBtn = new JButton("Issue Prescription");
        JButton editBtn = new JButton("Edit Selected");
        JButton deleteBtn = new JButton("Delete Selected");

        refreshBtn.addActionListener(e -> loadPrescriptions());
        addBtn.addActionListener(e -> showAddPrescriptionDialog());
        editBtn.addActionListener(e -> editPrescription());
        deleteBtn.addActionListener(e -> deletePrescription());

        btnPanel.add(refreshBtn); btnPanel.add(addBtn); btnPanel.add(editBtn); btnPanel.add(deleteBtn);
        panel.add(btnPanel, BorderLayout.SOUTH);

        loadPrescriptions();
        return panel;
    }

    private JPanel createReferralPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        refModel = new DefaultTableModel(new String[]{"ID", "Patient ID", "GP ID", "Specialist ID", "Reason", "Date"}, 0);
        referralTable = new JTable(refModel);
        panel.add(new JScrollPane(referralTable), BorderLayout.CENTER);

        JPanel btnPanel = new JPanel();
        JButton refreshBtn = new JButton("Refresh");
        JButton addBtn = new JButton("Make Referral");
        JButton editBtn = new JButton("Edit Selected");
        JButton deleteBtn = new JButton("Delete Selected");

        refreshBtn.addActionListener(e -> loadReferrals());
        addBtn.addActionListener(e -> showAddReferralDialog());
        editBtn.addActionListener(e -> editReferral());
        deleteBtn.addActionListener(e -> deleteReferral());

        btnPanel.add(refreshBtn); btnPanel.add(addBtn); btnPanel.add(editBtn); btnPanel.add(deleteBtn);
        panel.add(btnPanel, BorderLayout.SOUTH);

        loadReferrals();
        return panel;
    }

    private JPanel createPatientPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        patModel = new DefaultTableModel(new String[]{"ID", "DOB", "Medical History"}, 0);
        patientTable = new JTable(patModel);
        panel.add(new JScrollPane(patientTable), BorderLayout.CENTER);

        JPanel btnPanel = new JPanel();
        JButton refreshBtn = new JButton("Refresh");
        JButton addBtn = new JButton("Register Patient");
        JButton editBtn = new JButton("Edit History");
        JButton deleteBtn = new JButton("Delete Selected");

        refreshBtn.addActionListener(e -> loadPatients());
        addBtn.addActionListener(e -> showAddPatientDialog());
        editBtn.addActionListener(e -> editPatientHistory());
        deleteBtn.addActionListener(e -> deletePatient());

        btnPanel.add(refreshBtn); btnPanel.add(addBtn); btnPanel.add(editBtn); btnPanel.add(deleteBtn);
        panel.add(btnPanel, BorderLayout.SOUTH);

        loadPatients();
        return panel;
    }

    // REAL DATA LOADING FROM CONTROLLERS
    private void loadAppointments() {
        aptModel.setRowCount(0);
        for (Appointment a : appointmentController.getAppointments()) {
            aptModel.addRow(new Object[]{a.getApptID(), a.getDate(), a.getTime(), a.getPatientID(), a.getDoctorID()});
        }
    }

    private void loadPrescriptions() {
        prescModel.setRowCount(0);
        for (Prescription p : prescriptionController.getPrescriptions()) {
            prescModel.addRow(new Object[]{p.getPresID(), p.getPatientID(), p.getCondition(), p.getDrug(), p.getDateIssued()});
        }
    }

    private void loadReferrals() {
        refModel.setRowCount(0);
        for (Referral r : referralController.getReferrals()) {
            refModel.addRow(new Object[]{r.getRefID(), r.getPatientID(), r.getGpID(), r.getSpecialistID(), r.getReason(), r.getDate()});
        }
    }

    private void loadPatients() {
        patModel.setRowCount(0);
        for (Patient p : patientController.getPatients()) {
            patModel.addRow(new Object[]{p.getPatientID(), p.getDob(), p.getMedicalHistory()});
        }
    }

    // ADD DIALOGS (SAFE WITH ERROR HANDLING)
    private void showAddAppointmentDialog() {
        JTextField patId = new JTextField(5);
        JTextField docId = new JTextField(5);
        JPanel p = new JPanel(new GridLayout(0, 2));
        p.add(new JLabel("Patient ID:")); p.add(patId);
        p.add(new JLabel("Doctor ID:")); p.add(docId);

        if (JOptionPane.showConfirmDialog(this, p, "Add Appointment", JOptionPane.OK_CANCEL_OPTION) == JOptionPane.OK_OPTION) {
            try {
                int pId = Integer.parseInt(patId.getText().trim());
                int dId = Integer.parseInt(docId.getText().trim());
                appointmentController.bookAppointment(pId, dId, LocalDate.now(), LocalTime.now());
                loadAppointments();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Invalid input! IDs must be numbers.");
            }
        }
    }

    private void showAddPrescriptionDialog() {
        JTextField patId = new JTextField(5);
        JTextField condition = new JTextField(15);
        JTextField drug = new JTextField(15);
        JPanel p = new JPanel(new GridLayout(0, 2));
        p.add(new JLabel("Patient ID:")); p.add(patId);
        p.add(new JLabel("Condition:")); p.add(condition);
        p.add(new JLabel("Drug:")); p.add(drug);

        if (JOptionPane.showConfirmDialog(this, p, "Issue Prescription", JOptionPane.OK_CANCEL_OPTION) == JOptionPane.OK_OPTION) {
            try {
                int pId = Integer.parseInt(patId.getText().trim());
                prescriptionController.createPrescription(pId, condition.getText(), drug.getText(), LocalDate.now());
                loadPrescriptions();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Patient ID must be a number!");
            }
        }
    }

    private void showAddReferralDialog() {
        JTextField patId = new JTextField(5);
        JTextField gpId = new JTextField(5);
        JTextField specId = new JTextField(5);
        JTextField reason = new JTextField(20);
        JPanel p = new JPanel(new GridLayout(0, 2));
        p.add(new JLabel("Patient ID:")); p.add(patId);
        p.add(new JLabel("GP ID:")); p.add(gpId);
        p.add(new JLabel("Specialist ID:")); p.add(specId);
        p.add(new JLabel("Reason:")); p.add(reason);

        if (JOptionPane.showConfirmDialog(this, p, "Make Referral", JOptionPane.OK_CANCEL_OPTION) == JOptionPane.OK_OPTION) {
            try {
                int pId = Integer.parseInt(patId.getText().trim());
                int gId = Integer.parseInt(gpId.getText().trim());
                int sId = Integer.parseInt(specId.getText().trim());
                referralController.makeReferral(pId, gId, sId, reason.getText(), LocalDate.now(), "Referral note");
                patientController.updateEHR(pId, "Referred: " + reason.getText());
                loadReferrals();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "IDs must be numbers!");
            }
        }
    }

    private void showAddPatientDialog() {
        JTextField dob = new JTextField("yyyy-mm-dd", 10);
        JPanel p = new JPanel();
        p.add(new JLabel("DOB (yyyy-mm-dd):")); p.add(dob);

        if (JOptionPane.showConfirmDialog(this, p, "Register Patient", JOptionPane.OK_CANCEL_OPTION) == JOptionPane.OK_OPTION) {
            try {
                LocalDate date = LocalDate.parse(dob.getText().trim());
                patientController.registerPatient(date, "New patient registered");
                loadPatients();
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "Invalid date format! Use yyyy-mm-dd");
            }
        }
    }

    // EDIT AND DELETE (demo â€” updates table, real delete would need controller methods)
    private void editAppointment() {
        int row = appointmentTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select an appointment!"); return; }
        String newTime = JOptionPane.showInputDialog("New Time (HH:mm):", aptModel.getValueAt(row, 2));
        if (newTime != null) {
            aptModel.setValueAt(newTime, row, 2);
            JOptionPane.showMessageDialog(this, "Appointment updated!");
        }
    }

    private void editPrescription() {
        int row = prescriptionTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a prescription!"); return; }
        String newDrug = JOptionPane.showInputDialog("New Drug:", prescModel.getValueAt(row, 3));
        if (newDrug != null) {
            prescModel.setValueAt(newDrug, row, 3);
            JOptionPane.showMessageDialog(this, "Prescription updated!");
        }
    }

    private void editReferral() {
        int row = referralTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a referral!"); return; }
        String newReason = JOptionPane.showInputDialog("New Reason:", refModel.getValueAt(row, 4));
        if (newReason != null) {
            refModel.setValueAt(newReason, row, 4);
            JOptionPane.showMessageDialog(this, "Referral updated!");
        }
    }

    private void editPatientHistory() {
        int row = patientTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a patient!"); return; }
        int id = (int) patModel.getValueAt(row, 0);
        String newHistory = JOptionPane.showInputDialog("New Medical History:", patModel.getValueAt(row, 2));
        if (newHistory != null) {
            patientController.updateEHR(id, newHistory);
            loadPatients();
        }
    }

    private void deleteAppointment() {
        int row = appointmentTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select an appointment!"); return; }
        if (JOptionPane.showConfirmDialog(this, "Delete this appointment?") == JOptionPane.YES_OPTION) {
            aptModel.removeRow(row);
            JOptionPane.showMessageDialog(this, "Appointment deleted!");
        }
    }

    private void deletePrescription() {
        int row = prescriptionTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a prescription!"); return; }
        if (JOptionPane.showConfirmDialog(this, "Delete this prescription?") == JOptionPane.YES_OPTION) {
            prescModel.removeRow(row);
            JOptionPane.showMessageDialog(this, "Prescription deleted!");
        }
    }

    private void deleteReferral() {
        int row = referralTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a referral!"); return; }
        if (JOptionPane.showConfirmDialog(this, "Delete this referral?") == JOptionPane.YES_OPTION) {
            refModel.removeRow(row);
            JOptionPane.showMessageDialog(this, "Referral deleted!");
        }
    }

    private void deletePatient() {
        int row = patientTable.getSelectedRow();
        if (row == -1) { JOptionPane.showMessageDialog(this, "Select a patient!"); return; }
        if (JOptionPane.showConfirmDialog(this, "Delete this patient?") == JOptionPane.YES_OPTION) {
            patModel.removeRow(row);
            JOptionPane.showMessageDialog(this, "Patient deleted!");
        }
    }
}
